#!/bin/bash
set -e
set -o pipefail

# exec >> /tmp/monitor-hotplug.log
# exec 2>&1

# Based on https://github.com/jessfraz/dotfiles/tree/master/bin/monitor-hotplug
# Inspired by: https://github.com/codingtony/udev-monitor-hotplug

# Get the devices.
DEVICES=$(find /sys/class/drm/*/status)

# Get the display.
export DISPLAY=":1.0"
# displaynum=$(find /tmp/.X11-unix/ -type s | sed s#/tmp/.X11-unix/X##)
# export DISPLAY=":${displaynum}.0"

# From:
# 	https://wiki.archlinux.org/index.php/Acpid#Laptop_Monitor_Power_Off
xauth=$(ps -C Xorg -f --no-header | sed -n 's/.*-auth //; s/ -[^ ].*//; p')
export XAUTHORITY="$xauth"

# Iterate over the devices.
while read -r line; do
	dir=$(dirname "$line");
	status=$(cat "$line");
	# shellcheck disable=SC1001
	dev=$(echo "$dir" | cut -d\- -f 2-);

	if [[ "$dev" = "HDMI"* ]]; then
		# Remove the "-X-" part from "HDMI-X-n".
		dev=HDMI${dev#HDMI-?-}
	else
		dev=$(echo "$dev" | tr -d '-')
	fi

	if [[ "connected" == "$status" ]]; then
		echo "$dev is connected."
		# Create the variable.
		# shellcheck disable=SC2140
		declare "$dev"="yes"
	fi
done <<< "$DEVICES"

# home_monitors() {
	# xrandr --output eDP1 --off \
		# --output DP2-2 --mode 3840x2160 --rate 60 --rotate normal --pos 0x900 \
		# --output DP1-2 --mode 3840x2160 --rate 60 --rotate left --pos 3840x0
# }

home_monitor() {
  set -x
  echo "before $DISPLAY"
	xrandr --output eDP-1-1 --primary --mode 3840x2160 --rate 60 \
		--output DP-1-1-2 --mode 2560x1440 --rate 60 --right-of eDP-1-1
  echo "after"
}

# shellcheck disable=SC2154
if [[ -n "$eDP1" ]] && [[ -n "$DP5" ]] || [[ -n "$eDP1" ]] && [[ -n "$DP6" ]]; then
	echo "DP5 is plugged in"

	home_monitor;
elif [[ -n "$eDP1" ]]; then
	# This check obviously needs to be last.
	echo "Only the internal display was found."

	# Reset xrandr.
	xrandr --output eDP-1-1 --primary
  xrandr --auto
else
	echo "No external monitors are plugged in"

	# Reset xrandr.
	xrandr --auto
fi
